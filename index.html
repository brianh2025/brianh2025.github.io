<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公文處理方式快速回覆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        td {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen py-12">
    <div class="w-full max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">公文處理方式快速回覆</h1>
                <p class="text-gray-500 mt-2">輸入重點，快速產生簡要處理方式的回覆</p>
            </div>

            <!-- Input Form -->
            <div class="space-y-6">
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-2">您的 Gemini API 金鑰 (選填)</label>
                    <input type="password" id="api-key-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="若留空，將使用預設模型">
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label for="document-requirements" class="block text-sm font-medium text-gray-700">1. 輸入公文要求重點</label>
                        <button id="preset-btn-archive" class="text-xs bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-full px-3 py-1 transition">填入歸檔範本</button>
                    </div>
                    <textarea id="document-requirements" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="請在此輸入或貼上公文的重點要求事項..."></textarea>
                </div>
                <div><label for="due-date" class="block text-sm font-medium text-gray-700 mb-2">2. 選擇預定完成日期 (參考用)</label><input type="date" id="due-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></div>
                <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out flex items-center justify-center"><svg id="button-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg><span id="button-text">產生回覆</span></button>
            </div>

            <!-- Output Section -->
            <div id="output-section" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">產生的回覆內容：</h2>
                <div id="loading-spinner" class="flex justify-center items-center h-40"><div class="loader"></div></div>
                <div id="result-container" class="hidden">
                    <div id="generated-text" class="w-full p-4 bg-gray-100 border border-gray-200 rounded-lg whitespace-pre-wrap min-h-[100px]"></div>
                    <div class="mt-4 flex space-x-2">
                        <button id="copy-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>複製內容</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Table Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">歷次回覆紀錄</h2>
                <button id="clear-history-btn" class="bg-red-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition duration-150 ease-in-out">清除所有紀錄</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">產生日期</th><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">輸入重點</th><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">產生回覆</th><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">參考完成日</th><th scope="col" class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th></tr></thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                 <p id="no-history-msg" class="text-center text-gray-500 py-8">目前沒有任何歷史紀錄。</p>
            </div>
        </div>

        <div id="message-box" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transform translate-y-4 transition-all duration-300"></div>
    </div>

    <script>
        // DOM element references
        const generateBtn = document.getElementById('generate-btn'), buttonText = document.getElementById('button-text'), buttonIcon = document.getElementById('button-icon'), docRequirementsInput = document.getElementById('document-requirements'), dueDateInput = document.getElementById('due-date'), outputSection = document.getElementById('output-section'), loadingSpinner = document.getElementById('loading-spinner'), resultContainer = document.getElementById('result-container'), generatedTextDiv = document.getElementById('generated-text'), copyBtn = document.getElementById('copy-btn'), messageBox = document.getElementById('message-box'), historyTableBody = document.getElementById('history-table-body'), clearHistoryBtn = document.getElementById('clear-history-btn'), noHistoryMsg = document.getElementById('no-history-msg'), presetBtnArchive = document.getElementById('preset-btn-archive'), apiKeyInput = document.getElementById('api-key-input');
        const STORAGE_KEY_HISTORY = 'gongwen_history_brief';
        const STORAGE_KEY_API = 'gemini_api_key';

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date(), defaultDueDate = new Date(today);
            defaultDueDate.setDate(today.getDate() + 7);
            dueDateInput.value = defaultDueDate.toISOString().split('T')[0];
            
            // Load saved history and API key
            loadHistory();
            const savedApiKey = localStorage.getItem(STORAGE_KEY_API);
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
        });

        const getHistory = () => JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
        const saveHistory = (history) => localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));

        const loadHistory = () => {
            historyTableBody.innerHTML = '';
            const history = getHistory();
            noHistoryMsg.classList.toggle('hidden', history.length > 0);
            history.forEach(addRecordToTable);
        };

        const addRecordToHistory = (record) => {
            const history = getHistory();
            history.unshift(record);
            saveHistory(history);
            loadHistory();
        };
        
        const addRecordToTable = (record) => {
            const row = document.createElement('tr');
            row.dataset.id = record.id;
            row.innerHTML = `<td class="px-4 py-4 text-sm text-gray-500">${new Date(record.timestamp).toLocaleString('zh-TW')}</td><td class="px-4 py-4 text-sm text-gray-900">${record.requirements}</td><td class="px-4 py-4 text-sm text-gray-900">${record.generatedText}</td><td class="px-4 py-4 text-sm text-gray-500">${record.dueDate}</td><td class="px-2 py-4 text-center"><button class="delete-btn text-red-500 hover:text-red-700" title="刪除此筆紀錄"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></td>`;
            historyTableBody.appendChild(row);
            row.querySelector('.delete-btn').addEventListener('click', () => deleteRecord(record.id));
        };

        const deleteRecord = (id) => {
            saveHistory(getHistory().filter(record => record.id !== id));
            loadHistory();
            showMessage('紀錄已刪除', 'info');
        };

        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('您確定要清除所有歷史紀錄嗎？此操作無法復原。')) {
                localStorage.removeItem(STORAGE_KEY_HISTORY);
                loadHistory();
                showMessage('所有紀錄已清除', 'info');
            }
        });

        const generateContent = async () => {
            const requirements = docRequirementsInput.value.trim(), dueDate = dueDateInput.value;
            if (!requirements) { showMessage('請輸入公文要求重點。', 'error'); return; }
            if (!dueDate) { showMessage('請選擇預定完成日期。', 'error'); return; }
            setLoadingState(true);

            const prompt = `針對以下公文重點，請用一段簡潔、專業的文字，回覆預計的處理方式。\n\n---公文重點---\n${requirements}`;
            
            try {
                const trimmedContent = (await callTextApi(prompt)).trim();
                generatedTextDiv.textContent = trimmedContent;
                resultContainer.classList.remove('hidden');
                addRecordToHistory({ id: Date.now().toString(), timestamp: new Date().toISOString(), requirements, dueDate, generatedText: trimmedContent });
            } catch (error) {
                console.error("API call failed:", error);
                generatedTextDiv.textContent = '內容生成失敗，請稍後再試。';
                resultContainer.classList.remove('hidden');
            } finally {
                setLoadingState(false);
            }
        };
        
        const callApiWithRetry = async (apiUrl, payload, retries = 5, delay = 1500) => {
             const apiKey = apiKeyInput.value.trim(); // Use the key from the input field
             const fullApiUrl = `${apiUrl}?key=${apiKey}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(fullApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        const reason = result?.promptFeedback?.blockReason || 'Unknown reason';
                        throw new Error(`Invalid API response structure or empty content. Reason: ${reason}`);
                    }
                } catch (error) {
                    console.warn(`API call attempt ${i + 1} failed with error: ${error.message}. Retrying in ${delay}ms...`);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 1.5;
                    } else { 
                        console.error("API call failed after all retries.");
                        throw error; 
                    }
                }
            }
        };

        const callTextApi = (prompt) => callApiWithRetry('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent', { contents: [{ role: "user", parts: [{ text: prompt }] }] });

        const setLoadingState = (isLoading) => {
            generateBtn.disabled = isLoading;
            buttonText.textContent = isLoading ? '生成中...' : '產生回覆';
            buttonIcon.innerHTML = isLoading 
                ? `<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>` 
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>`;

            if (isLoading) {
                outputSection.classList.remove('hidden');
                loadingSpinner.classList.remove('hidden');
                resultContainer.classList.add('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        };
        
        const copyToClipboard = () => {
            const textToCopy = generatedTextDiv.textContent;
            if (!textToCopy) return;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                showMessage('已成功複製！', 'success');
            } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
            document.body.removeChild(tempTextArea);
        };

        const showMessage = (message, type = 'success') => {
            messageBox.textContent = message;
            messageBox.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl transform transition-all duration-300';
            messageBox.classList.add(type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-500' : 'bg-green-500'), 'opacity-100', 'translate-y-0');
            setTimeout(() => { messageBox.classList.replace('opacity-100', 'opacity-0'); messageBox.classList.replace('translate-y-0', 'translate-y-4'); }, 3000);
        };

        // Event Listeners
        generateBtn.addEventListener('click', generateContent);
        copyBtn.addEventListener('click', copyToClipboard);
        presetBtnArchive.addEventListener('click', () => {
            const presetText = "轉行政助理XX，函文相關核定之紙本及電子檔進行歸檔作業，作業完成後佈達歸檔位置。";
            docRequirementsInput.value = presetText;
            showMessage('已填入歸檔範本', 'info');
        });
        apiKeyInput.addEventListener('input', (e) => {
            localStorage.setItem(STORAGE_KEY_API, e.target.value);
        });
    </script>
</body>
</html>
